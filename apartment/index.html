<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Babylon.js Viewer 14 Example</title>
    <script src="https://preview.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/materialsLibrary/babylon.gridMaterial.js"></script>
    <script src="https://code.jquery.com/pep/0.4.1/pep.js"></script>
    <script src="https://unpkg.com/earcut@latest/dist/earcut.min.js"></script>
    <style>
      html, body {
        width: 100%;
        height: 100%;
        overflow: hidden;
        margin: 0;
      }
      #renderCanvas {
        width   : 100%;
        height  : 100%;
        touch-action: none;
      }
    </style>
  </head>
  <body>
    <canvas id="renderCanvas"></canvas>
    <script>
        function main() {
          const canvas = document.getElementById('renderCanvas');
          const engine = new BABYLON.Engine(canvas);

          function degree(degrees) {
            return degrees * (Math.PI / 180);
          }

          const TARGET_BOOTH_ID = "A1";

          const createScene = function () {
              const scene = new BABYLON.Scene(engine);

              const camera = new BABYLON.ArcRotateCamera("Camera", 0, 0, 0, BABYLON.Vector3.Zero(), scene);
              camera.position = new BABYLON.Vector3(180, 20, 30);
              camera.setTarget(new BABYLON.Vector3(160/2, 0, 46/2));
              camera.attachControl(canvas, true);
              camera.wheelDeltaPercentage = 0.005;

              const light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, 0), scene);
              light.intensity = 0.8;

              // Sky
              const skybox = BABYLON.MeshBuilder.CreateBox("skyBox", {size: 1000}, scene);
              const skyboxMaterial = new BABYLON.StandardMaterial("skyBox", scene);
                    skyboxMaterial.backFaceCulling = false;

                    skyboxMaterial.reflectionTexture = new BABYLON.CubeTexture("textures/skybox", scene);
                    skyboxMaterial.reflectionTexture.coordinatesMode = BABYLON.Texture.SKYBOX_MODE;

                    skyboxMaterial.diffuseColor = new BABYLON.Color3(0, 0, 0);
                    skyboxMaterial.specularColor = new BABYLON.Color3(0, 0, 0);
                    skybox.material = skyboxMaterial;
              
              //Create Village ground
              const groundMat = new BABYLON.StandardMaterial("groundMat");
              groundMat.diffuseTexture = new BABYLON.Texture("textures/ground/villagegreen.png");
              groundMat.diffuseTexture.hasAlpha = true;

              const ground = BABYLON.MeshBuilder.CreateGround("ground", {width:200, height:100});
              ground.material = groundMat;
              ground.rotation.y = degree(180);
              ground.position.x = 50;
              ground.position.y = 0;
              ground.position.z = 44;

              const wallMaterial = new BABYLON.StandardMaterial("wallMaterial", scene);
              wallMaterial.diffuseColor = new BABYLON.Color3(1, 0, 1);
              wallMaterial.specularColor = new BABYLON.Color3(0.5, 0.6, 0.87);
              wallMaterial.emissiveColor = new BABYLON.Color3(1, 1, 1);
              wallMaterial.ambientColor = new BABYLON.Color3(0.23, 0.98, 0.53);
              wallMaterial.alpha = 0.5;

              const doorMaterial = new BABYLON.StandardMaterial("doorMaterial", scene);
              doorMaterial.diffuseColor = new BABYLON.Color3(1, 0, 1);
              doorMaterial.specularColor = new BABYLON.Color3(0.5, 0.6, 0.87);
              doorMaterial.emissiveColor = new BABYLON.Color3(0.75, 0.24, 0.24);
              doorMaterial.ambientColor = new BABYLON.Color3(0.23, 0.98, 0.53);
              doorMaterial.alpha = 0.9;


              // 壁
              let bDt = getWallData();
              for (let i = 0; bDt.length > i; i++) {
                  createBox(bDt[i].id, bDt[i].x1, bDt[i].y1, bDt[i].z1, bDt[i].x2, bDt[i].y2, bDt[i].z2, wallMaterial);
              }

              // 柱
              let pDt = getPillarData();
              for (let i = 0; pDt.length > i; i++) {
                  createPillar(pDt[i].id, pDt[i].x, pDt[i].y, pDt[i].z, pDt[i].r, pDt[i].h, pDt[i].shape, wallMaterial);
              }

              // 出入口
              let brDt = getDoorData();
              for (let i = 0; brDt.length > i; i++) {
                  createBox(brDt[i].id, brDt[i].x1, brDt[i].y1, brDt[i].z1, brDt[i].x2, brDt[i].y2, brDt[i].z2, doorMaterial);
              }

              // ブース
              let btDt = getBoothData();
              for (let i = 0; btDt.length > i; i++) {
                  createBooth(btDt[i].id, btDt[i].x1, btDt[i].y1, btDt[i].z1, btDt[i].x2, btDt[i].y2, btDt[i].z2, wallMaterial);
              }

              // ターゲットブース
              const myBooth = scene.getMeshById(`booth_${TARGET_BOOTH_ID}`);
              const highlighter = new BABYLON.HighlightLayer("highlighter", scene);
              highlighter.addMesh(myBooth, BABYLON.Color3.Yellow());

              const radius = 2;
              //const angle = Math.PI / 3;
              const angle = Math.PI / 10;
              const particleSystem = new BABYLON.ParticleSystem("particles", 2000, scene);
              particleSystem.particleTexture = new BABYLON.Texture("textures/flare.png", scene);

              particleSystem.emitter = BABYLON.Vector3.Zero();
              particleSystem.emitter.z = myBooth.position.z;
              particleSystem.emitter.x = myBooth.position.x;

              particleSystem.color1 = new BABYLON.Color4(0.77, 0.81, 0.45);
              particleSystem.color2 = new BABYLON.Color4(0.89, 0.36, 0.73);
              particleSystem.colorDead = new BABYLON.Color4(0, 0, 0.2, 0.0);
              particleSystem.minSize = 0.1;
              particleSystem.maxSize = 0.5;
              particleSystem.minLifeTime = 0.3;
              particleSystem.maxLifeTime = 1.5;
              particleSystem.emitRate = 1000;
              particleSystem.createConeEmitter(radius, angle);
              particleSystem.minEmitPower = 2;
              particleSystem.maxEmitPower = 4;
              particleSystem.updateSpeed = 0.005;
              particleSystem.start();

              return scene;
          };

          function createBox(id, x1, y1, z1, x2, y2, z2, mate) {
              if (x1 == x2) { x2 = x2 + 0.2 }
              if (z1 == z2) { z2 = z2 + 0.2 }
              if (x1 > x2) { [x1, x2] = [x2, x1]; }
              if (z1 > z2) { [z1, z2] = [z2, z1]; }
              
              if (id == null || id == undefined) {
                id = "";
              }

              const box = BABYLON.MeshBuilder.CreateBox(`box_${id}`, { width: Math.abs(x1 - x2), height: Math.abs(y1 - y2), depth: Math.abs(z1 - z2) })
              box.position.x = x1 + Math.abs(x1 - x2) / 2;
              box.position.y = y1 + Math.abs(y1 - y2) / 2;
              box.position.z = z1 + Math.abs(z1 - z2) / 2;
              box.material = mate;
          }

          function createBooth(id, x1, y1, z1, x2, y2, z2, mate) {
              if (x1 == x2) { x2 = x2 + 0.2 }
              if (z1 == z2) { z2 = z2 + 0.2 }
              if (x1 > x2) { [x1, x2] = [x2, x1]; }
              if (z1 > z2) { [z1, z2] = [z2, z1]; }
              
              if (id == null || id == undefined) {
                id = "";
              }

              const box = BABYLON.MeshBuilder.CreateBox(`booth_${id}`, { width: Math.abs(x1 - x2), height: Math.abs(y1 - y2), depth: Math.abs(z1 - z2) })
              box.position.x = x1 + Math.abs(x1 - x2) / 2;
              box.position.y = y1 + Math.abs(y1 - y2) / 2;
              box.position.z = z1 + Math.abs(z1 - z2) / 2;
              box.material = mate;
          }

          function createPillar(id, x, y, z, r, h, shape, mate) {
              if (shape == "box") {
                  let pillar = BABYLON.MeshBuilder.CreateBox(`pillar_x${x}_z${z}`, { height: h, width: r, depth: r });
                  pillar.position = new BABYLON.Vector3(x, y + h / 2, z);

              } else {
                  let pillar = BABYLON.MeshBuilder.CreateCylinder(`pillar_x${x}_z${z}`, { height: h, width: r, depth: r });
                  pillar.position = new BABYLON.Vector3(x, y + h / 2, z);
              }
          }

          function getWallData() {
              let boxData = [
                  { "x1": 6.4, "y1": 0, "z1": 5.9, "x2": 6.4, "y2": 10, "z2": 24 },
                  { "x1": 6.4, "y1": 0, "z1": 24, "x2": 9.6, "y2": 10, "z2": 24 },
                  { "x1": 9.6, "y1": 0, "z1": 24, "x2": 9.6, "y2": 10, "z2": 38 },
                  { "x1": 6.4, "y1": 0, "z1": 38, "x2": 44.8, "y2": 10, "z2": 38 },
                  { "x1": 44.8, "y1": 0, "z1": 38.4, "x2": 44.8, "y2": 10, "z2": 22.4 },
                  { "x1": 44.8, "y1": 0, "z1": 22.4, "x2": 78.4, "y2": 10, "z2": 22.4 },
                  { "x1": 78.4, "y1": 0, "z1": 22.4, "x2": 78.4, "y2": 10, "z2": 33.6 },
                  { "x1": 78.4, "y1": 0, "z1": 33.6, "x2": 137.4, "y2": 10, "z2": 33.6 },
                  { "x1": 137.4, "y1": 0, "z1": 33.6, "x2": 137.4, "y2": 10, "z2": 22.4 },
                  { "x1": 137.4, "y1": 0, "z1": 22.4, "x2": 138.8, "y2": 10, "z2": 22.4 },
                  { "x1": 138.8, "y1": 0, "z1": 22.4, "x2": 138.8, "y2": 10, "z2": 5.9 },
                  { "x1": 138.8, "y1": 0, "z1": 5.9, "x2": 6.4, "y2": 10, "z2": 5.9 },

                  { "x1": 6.4, "y1": 0, "z1": 37.9, "x2": 6.4, "y2": 10, "z2": 44.3 },
                  { "x1": 6.4, "y1": 0, "z1": 44.3, "x2": 57.6, "y2": 10, "z2": 44.3 },
                  { "x1": 57.6, "y1": 0, "z1": 44.3, "x2": 57.6, "y2": 10, "z2": 35.9 },
                  { "x1": 57.6, "y1": 0, "z1": 35.9, "x2": 70.4, "y2": 10, "z2": 35.9 },
                  { "x1": 6.4, "y1": 0, "z1": 40.4, "x2": 57.6, "y2": 10, "z2": 40.4 },
                  { "x1": 70.4, "y1": 0, "z1": 35.9, "x2": 70.4, "y2": 10, "z2": 38.4 },
                  { "x1": 70.4, "y1": 0, "z1": 38.4, "x2": 140.8, "y2": 10, "z2": 38.4 },
                  { "x1": 140.8, "y1": 0, "z1": 38.4, "x2": 140.8, "y2": 10, "z2": 44.3 },
                  { "x1": 140.8, "y1": 0, "z1": 44.3, "x2": 70.4, "y2": 10, "z2": 44.3 },

                  { "x1": 6.4, "y1": 0, "z1": 0, "x2": 6.4, "y2": 10, "z2": 4 },
                  { "x1": 6.4, "y1": 0, "z1": 4, "x2": 19.2, "y2": 10, "z2": 4 },
                  { "x1": 19.2, "y1": 0, "z1": 4, "x2": 19.2, "y2": 10, "z2": 0 },
                  { "x1": 19.2, "y1": 0, "z1": 0, "x2": 6.4, "y2": 10, "z2": 0 },

                  { "x1": 22, "y1": 0, "z1": 0, "x2": 22, "y2": 10, "z2": 4 },
                  { "x1": 22, "y1": 0, "z1": 4, "x2": 60.4, "y2": 10, "z2": 4 },
                  { "x1": 60.4, "y1": 0, "z1": 4, "x2": 60.4, "y2": 10, "z2": 0 },
                  { "x1": 60.4, "y1": 0, "z1": 0, "x2": 22, "y2": 10, "z2": 0 },

                  { "x1": 66.8, "y1": 0, "z1": 0, "x2": 66.8, "y2": 10, "z2": 4 },
                  { "x1": 66.8, "y1": 0, "z1": 4, "x2": 101.2, "y2": 10, "z2": 4 },
                  { "x1": 101.2, "y1": 0, "z1": 4, "x2": 101.2, "y2": 10, "z2": 0 },
                  { "x1": 101.2, "y1": 0, "z1": 0, "x2": 66.8, "y2": 10, "z2": 0 },

                  { "x1": 105.2, "y1": 0, "z1": 0, "x2": 105.2, "y2": 10, "z2": 4 },
                  { "x1": 105.2, "y1": 0, "z1": 4, "x2": 137.2, "y2": 10, "z2": 4 },
                  { "x1": 137.2, "y1": 0, "z1": 4, "x2": 137.2, "y2": 10, "z2": 0 },
                  { "x1": 137.2, "y1": 0, "z1": 0, "x2": 105.2, "y2": 10, "z2": 0 },
              ];
              return boxData;
          }

          function getDoorData() {
              let boxData = [
                  { "x1": 44.6, "y1": 0, "z1": 30, "x2": 46, "y2": 2.8, "z2": 28 },
              ];
              return boxData; 
          }

          function getPillarData() {
              let pData = [
                  { "x": 12.8, "y": 0, "z": 22.4, "r": 1, "h": 10, "shape": "circle" },
                  { "x": 19.2, "y": 0, "z": 22.4, "r": 1, "h": 10, "shape": "circle" },
                  { "x": 32, "y": 0, "z": 22.4, "r": 1, "h": 10, "shape": "circle" },
                  { "x": 44.8, "y": 0, "z": 22.4, "r": 1, "h": 10, "shape": "circle" },
                  { "x": 57.6, "y": 0, "z": 22.4, "r": 1, "h": 10, "shape": "circle" },
                  { "x": 70.4, "y": 0, "z": 22.4, "r": 1, "h": 10, "shape": "circle" },
                  { "x": 83.2, "y": 0, "z": 22.4, "r": 1, "h": 10, "shape": "circle" },
                  { "x": 96, "y": 0, "z": 22.4, "r": 1, "h": 10, "shape": "circle" },
                  { "x": 108.8, "y": 0, "z": 22.4, "r": 1, "h": 10, "shape": "circle" },
                  { "x": 121.6, "y": 0, "z": 22.4, "r": 1, "h": 10, "shape": "circle" },
                  { "x": 134.4, "y": 0, "z": 22.4, "r": 1, "h": 10, "shape": "circle" },
                  { "x": 140.8, "y": 0, "z": 22.4, "r": 1, "h": 10, "shape": "circle" },

                  { "x": 12.8, "y": 0, "z": 6.3, "r": 1, "h": 10, "shape": "box" },
                  { "x": 19.2, "y": 0, "z": 6.3, "r": 1, "h": 10, "shape": "box" },
                  { "x": 32, "y": 0, "z": 6.3, "r": 1, "h": 10, "shape": "box" },
                  { "x": 44.8, "y": 0, "z": 6.3, "r": 1, "h": 10, "shape": "box" },
                  { "x": 57.6, "y": 0, "z": 6.3, "r": 1, "h": 10, "shape": "box" },
                  { "x": 70.4, "y": 0, "z": 6.3, "r": 1, "h": 10, "shape": "box" },
                  { "x": 83.2, "y": 0, "z": 6.3, "r": 1, "h": 10, "shape": "box" },
                  { "x": 96, "y": 0, "z": 6.3, "r": 1, "h": 10, "shape": "box" },
                  { "x": 108.8, "y": 0, "z": 6.3, "r": 1, "h": 10, "shape": "box" },
                  { "x": 121.6, "y": 0, "z": 6.3, "r": 1, "h": 10, "shape": "box" },
                  { "x": 134.4, "y": 0, "z": 6.3, "r": 1, "h": 10, "shape": "box" },
                  { "x": 140.8, "y": 0, "z": 6.3, "r": 1, "h": 10, "shape": "box" },

                  { "x": 6.4, "y": 0, "z": 38.4, "r": 1, "h": 10, "shape": "box" },
                  { "x": 12.8, "y": 0, "z": 38.4, "r": 1, "h": 10, "shape": "box" },
                  { "x": 19.2, "y": 0, "z": 38.4, "r": 1, "h": 10, "shape": "box" },
                  { "x": 32, "y": 0, "z": 38.4, "r": 1, "h": 10, "shape": "box" },
                  { "x": 44.8, "y": 0, "z": 38.4, "r": 1, "h": 10, "shape": "box" },
                  { "x": 57.6, "y": 0, "z": 38.4, "r": 1, "h": 10, "shape": "box" },
                  { "x": 70.4, "y": 0, "z": 38.4, "r": 1, "h": 10, "shape": "box" },
                  { "x": 83.2, "y": 0, "z": 38.4, "r": 1, "h": 10, "shape": "box" },
                  { "x": 96, "y": 0, "z": 38.4, "r": 1, "h": 10, "shape": "box" },
                  { "x": 108.8, "y": 0, "z": 38.4, "r": 1, "h": 10, "shape": "box" },
                  { "x": 121.6, "y": 0, "z": 38.4, "r": 1, "h": 10, "shape": "box" },
                  { "x": 134.4, "y": 0, "z": 38.4, "r": 1, "h": 10, "shape": "box" },
                  { "x": 140.8, "y": 0, "z": 38.4, "r": 1, "h": 10, "shape": "box" },

                  { "x": 6.4, "y": 0, "z": 0, "r": 1, "h": 10, "shape": "box" },
                  { "x": 12.8, "y": 0, "z": 0, "r": 1, "h": 10, "shape": "circle" },
                  { "x": 19.2, "y": 0, "z": 0, "r": 1, "h": 10, "shape": "circle" },
                  { "x": 32, "y": 0, "z": 0, "r": 1, "h": 10, "shape": "circle" },
                  { "x": 44.8, "y": 0, "z": 0, "r": 1, "h": 10, "shape": "circle" },
                  { "x": 57.6, "y": 0, "z": 0, "r": 1, "h": 10, "shape": "circle" },
                  { "x": 70.4, "y": 0, "z": 0, "r": 1, "h": 10, "shape": "circle" },
                  { "x": 83.2, "y": 0, "z": 0, "r": 1, "h": 10, "shape": "circle" },
                  { "x": 96, "y": 0, "z": 0, "r": 1, "h": 10, "shape": "circle" },
                  { "x": 108.8, "y": 0, "z": 0, "r": 1, "h": 10, "shape": "circle" },
                  { "x": 121.6, "y": 0, "z": 0, "r": 1, "h": 10, "shape": "circle" },
                  { "x": 134.4, "y": 0, "z": 0, "r": 1, "h": 10, "shape": "circle" },
                  { "x": 140.8, "y": 0, "z": 0, "r": 1, "h": 10, "shape": "circle" },

                  { "x": 6.4, "y": 0, "z": 44.8, "r": 1, "h": 10, "shape": "box" },
                  { "x": 12.8, "y": 0, "z": 44.8, "r": 1, "h": 10, "shape": "circle" },
                  { "x": 19.2, "y": 0, "z": 44.8, "r": 1, "h": 10, "shape": "circle" },
                  { "x": 32, "y": 0, "z": 44.8, "r": 1, "h": 10, "shape": "circle" },
                  { "x": 44.8, "y": 0, "z": 44.8, "r": 1, "h": 10, "shape": "circle" },
                  { "x": 57.6, "y": 0, "z": 44.8, "r": 1, "h": 10, "shape": "circle" },
                  { "x": 70.4, "y": 0, "z": 44.8, "r": 1, "h": 10, "shape": "circle" },
                  { "x": 83.2, "y": 0, "z": 44.8, "r": 1, "h": 10, "shape": "circle" },
                  { "x": 96, "y": 0, "z": 44.8, "r": 1, "h": 10, "shape": "circle" },
                  { "x": 108.8, "y": 0, "z": 44.8, "r": 1, "h": 10, "shape": "circle" },
                  { "x": 121.6, "y": 0, "z": 44.8, "r": 1, "h": 10, "shape": "circle" },
                  { "x": 134.4, "y": 0, "z": 44.8, "r": 1, "h": 10, "shape": "circle" },
                  { "x": 140.8, "y": 0, "z": 44.8, "r": 1, "h": 10, "shape": "circle" },
              ];
              return pData;
          }

          function getBoothData() {
              let boothData = [
                  { "id": "A1", "x1": 44.4, "y1": 0, "z1": 17.5, "x2": 44.85, "y2": 0.7, "z2": 19.3 },
                  { "id": "A2", "x1": 44.4, "y1": 0, "z1": 15.5, "x2": 44.85, "y2": 0.7, "z2": 17.3 },
                  { "id": "A3", "x1": 44.4, "y1": 0, "z1": 13.5, "x2": 44.85, "y2": 0.7, "z2": 15.3 },
                  { "id": "A4", "x1": 44.4, "y1": 0, "z1": 11.5, "x2": 44.85, "y2": 0.7, "z2": 13.3 },
                  { "id": "A5", "x1": 44.4, "y1": 0, "z1": 9.5, "x2": 44.85, "y2": 0.7, "z2": 11.3 },
                  { "id": "A6", "x1": 42.4, "y1": 0, "z1": 17.5, "x2": 42.85, "y2": 0.7, "z2": 19.3 },
                  { "id": "A7", "x1": 42.4, "y1": 0, "z1": 15.5, "x2": 42.85, "y2": 0.7, "z2": 17.3 },
                  { "id": "A8", "x1": 42.4, "y1": 0, "z1": 13.5, "x2": 42.85, "y2": 0.7, "z2": 15.3 },
                  { "id": "A9", "x1": 42.4, "y1": 0, "z1": 11.5, "x2": 42.85, "y2": 0.7, "z2": 13.3 },
                  { "id": "A10", "x1": 42.4, "y1": 0, "z1": 9.5, "x2": 42.85, "y2": 0.7, "z2": 11.3 },
                  { "id": "A11", "x1": 37.9, "y1": 0, "z1": 9.5, "x2": 38.35, "y2": 0.7, "z2": 11.3 },
                  { "id": "A12", "x1": 37.9, "y1": 0, "z1": 11.5, "x2": 38.35, "y2": 0.7, "z2": 13.3 },
                  { "id": "A13", "x1": 37.9, "y1": 0, "z1": 13.5, "x2": 38.35, "y2": 0.7, "z2": 15.3 },
                  { "id": "A14", "x1": 37.9, "y1": 0, "z1": 15.5, "x2": 38.35, "y2": 0.7, "z2": 17.3 },
                  { "id": "A15", "x1": 37.9, "y1": 0, "z1": 17.5, "x2": 38.35, "y2": 0.7, "z2": 19.3 },
                  { "id": "A16", "x1": 35.9, "y1": 0, "z1": 17.5, "x2": 36.35, "y2": 0.7, "z2": 19.3 },
                  { "id": "A17", "x1": 35.9, "y1": 0, "z1": 15.5, "x2": 36.35, "y2": 0.7, "z2": 17.3 },
                  { "id": "A18", "x1": 35.9, "y1": 0, "z1": 13.5, "x2": 36.35, "y2": 0.7, "z2": 15.3 },
                  { "id": "A19", "x1": 35.9, "y1": 0, "z1": 11.5, "x2": 36.35, "y2": 0.7, "z2": 13.3 },
                  { "id": "A20", "x1": 35.9, "y1": 0, "z1": 9.5, "x2": 36.35, "y2": 0.7, "z2": 11.3 },
              ];
              return boothData;
          }

          const scene = createScene();
          
          engine.runRenderLoop(() => {
            scene.render();
          });
          
          window.addEventListener('resize', () => {
            engine.resize();
          });
        }
        window.addEventListener('DOMContentLoaded', main);
    </script>
  </body>
</html>
